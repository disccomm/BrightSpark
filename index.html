<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BrightSpark Learning</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FFD166">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <style>
    /* --- DESIGN SYSTEM: GLASS MORPHISM & PLAYFUL --- */
    :root {
        --primary: #4D908E;     /* Teal */
        --secondary: #F94144;   /* Soft Red (Error/Danger) */
        --accent: #F9C74F;      /* Yellow (Highlight/Focus) */
        --bg-start: #E6F3FF;    /* Light Sky Blue */
        --bg-end: #F8F9FA;      /* Off-White */
        --surface: rgba(255, 255, 255, 0.9); /* Frosted Glass Base */
        --text: #277DA1;        /* Dark Blue Text */
        --success: #6CB85C;     /* Encouraging Green */
        --error: #F94144;
        --radius: 20px;         /* Deeper rounding for touch */
        --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15); /* Soft, deep shadow */
        --inner-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6); /* Glass highlight */
    }

    * { box-sizing: border-box; touch-action: manipulation; }
    body {
        font-family: 'Comic Neue', 'Verdana', sans-serif;
        /* Subtle Gradient Background */
        background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
        margin: 0;
        padding: 0;
        color: var(--text);
        overscroll-behavior-y: none;
        min-height: 100vh;
    }

    /* --- LAYOUTS --- */
    .screen { 
        display: none; 
        padding: 20px; 
        max-width: 800px; 
        margin: 0 auto; 
        min-height: 100vh; /* Use min-height for flexible scrolling */
        overflow-y: auto; 
        padding-bottom: 50px;
    }
    .screen.active { 
        display: flex; 
        flex-direction: column; 
    }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    h1, h2, h3 { margin: 0; color: var(--primary); font-weight: 800; }
    
    /* --- GLASSMOPHIC CARDS --- */
    .card {
        background: var(--surface);
        border-radius: var(--radius);
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.2); /* Frosted edge */
        margin-bottom: 20px;
        backdrop-filter: blur(8px); /* The key to the glass effect */
        -webkit-backdrop-filter: blur(8px);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    /* Simple hover/active feedback for non-touch devices */
    .card:active { transform: scale(0.99); box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.1); } 
    
    /* --- BUTTONS (Tactile & Colorful) --- */
    button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 14px 28px; /* Bigger padding for touch */
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
        box-shadow: 0 4px 0 var(--primary), var(--inner-shadow); /* Tactile 3D effect */
        transition: all 0.15s ease;
        min-height: 48px; /* Accessibility requirement for touch targets */
    }
    button:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--primary), var(--inner-shadow); }
    
    button.secondary { 
        background: var(--accent); 
        color: #333; 
        box-shadow: 0 4px 0 var(--accent), var(--inner-shadow); 
    }
    button.secondary:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--accent), var(--inner-shadow); }
    
    button.danger { 
        background: var(--secondary); 
        box-shadow: 0 4px 0 var(--secondary), var(--inner-shadow); 
    }
    button.danger:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--secondary), var(--inner-shadow); }

    button.outline { 
        background: transparent; 
        border: 2px solid var(--primary); 
        color: var(--primary); 
        box-shadow: none; 
    }
    
    button:disabled { 
        opacity: 0.4; 
        cursor: not-allowed; 
        box-shadow: none !important; 
        transform: none !important; 
        background: #ccc !important;
        color: #666 !important;
    }

    /* --- DASHBOARD --- */
    .topic-item { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: rgba(255, 255, 255, 0.8); /* Lighter glass */
        margin-bottom: 12px; 
        padding: 18px; 
        border-radius: 16px; 
        border: 1px solid rgba(255, 255, 255, 0.4); 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        cursor: pointer;
    }
    .topic-item.selected { 
        border: 3px solid var(--primary); 
        background-color: rgba(77, 144, 142, 0.1); /* Subtle teal background */
    }

    /* --- QUIZ UI --- */
    .progress-container { 
        height: 16px; /* Taller progress bar */
        background: rgba(255, 255, 255, 0.5); 
        border-radius: 10px; 
        margin: 15px 0; 
        overflow: hidden; 
        box-shadow: var(--inner-shadow);
    }
    .progress-bar { 
        height: 100%; 
        background: linear-gradient(90deg, #81c784 0%, var(--success) 100%); 
        width: 0%; 
        transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth animation */
    }
    
    .timer { font-size: 1.8rem; }
    
    .options-grid { display: grid; gap: 12px; margin-top: 20px; }
    .option-btn { 
        text-align: left; 
        background: rgba(255, 255, 255, 0.7); 
        color: var(--text); 
        border: 2px solid #ddd; 
        padding: 18px; 
        border-radius: 16px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }
    .option-btn:hover:not(.locked) { background: #f0f0f0; border-color: var(--primary); }
    .option-btn:active:not(.locked) { transform: scale(0.98); }
    
    /* Feedback States */
    .option-btn.correct { 
        background: var(--success); 
        border-color: #388e3c; 
        color: white;
        box-shadow: 0 4px 0 #388e3c;
    }
    .option-btn.correct:active { transform: translateY(2px); box-shadow: 0 2px 0 #388e3c; }

    .option-btn.wrong { 
        background: var(--error); 
        border-color: #d32f2f; 
        color: white;
        box-shadow: 0 4px 0 #d32f2f;
    }
    .option-btn.wrong:active { transform: translateY(2px); box-shadow: 0 2px 0 #d32f2f; }
    
    .option-btn.locked { pointer-events: none; opacity: 0.7; }

    .quiz-controls { display: flex; gap: 15px; margin-top: 30px; }
    .nav-btn { flex: 1; padding: 12px; }

    /* --- FLASHCARDS --- */
    .flashcard-front, .flashcard-back {
        border-width: 6px;
        border-style: solid;
        border-color: var(--accent);
        box-shadow: var(--shadow);
        background: var(--surface);
    }
    .flashcard-back { border-color: var(--primary); background: #f0f8ff; }


    /* --- UTILS --- */
    select { 
        appearance: none; 
        -webkit-appearance: none; 
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%234D908E" d="M10 4L6 8 2 4z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        padding-right: 30px !important;
    }
</style>
</head>
<body>

    <div id="dashboard" class="screen active">
<header>
    <h1>üìö My Library</h1>
    <button class="secondary" style="width: auto; padding: 8px 16px;" onclick="openImportModal()">+ Import</button>
</header>

        <div id="topic-container" class="card">
            <h3>Select a Topic:</h3>
            <ul id="topic-list" class="topic-list">
                <li style="text-align:center; color:#999; padding:20px;">No topics yet. Import a file!</li>
            </ul>
        </div>

        <div id="action-panel" class="hidden">
            <div class="card">
                <h3>Let's Practice!</h3>
<div style="margin-bottom: 20px;">
    <label for="grade-select" style="font-weight: bold; display: block; margin-bottom: 5px;">
        Choose Your **Learning Zone**:
    </label>
    <select id="grade-select" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem;">
        <option value="all">üöÄ Review Everything</option>
        <option value="4">üë∂ Starter Zone (Foundation)</option>
        <option value="7" selected>üí° Explorer Zone (Core Concepts)</option>
        <option value="10">üèÜ Master Zone (Challenge)</option>
    </select>
</div>
<hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
                <div style="margin-bottom: 15px;">
                    <label>Number of Questions: <span id="q-count-val">10</span></label>
                    <input type="range" id="q-slider" min="5" max="50" step="5" value="10" style="width:100%" oninput="updateSlider(this.value)">
                </div>
                
                <button onclick="startQuiz()">üöÄ Start Quiz</button>
                <button class="secondary" onclick="startFlashcards()">üé¥ Flashcards</button>
                <button class="outline" onclick="generateWorksheet()">üñ®Ô∏è Create Worksheet</button>
                <button class="outline" style="margin-top:10px" onclick="downloadTemplate()">‚¨áÔ∏è Get Template</button>
            </div>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
        <header>
            <button class="outline" style="width:auto; padding:5px 10px;" onclick="exitQuiz()">‚úï Exit</button>
            <div class="timer" id="timer">00:00</div>
        </header>
        
        <div class="progress-container">
            <div id="quiz-progress" class="progress-bar"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#666; font-size:0.9rem;">
                <span id="q-number">Q 1/10</span>
                <span id="q-score">Score: 0</span>
            </div>
            
            <img id="q-image" class="question-image hidden" src="" alt="Question Image">
            <h2 id="q-text" style="font-size:1.3rem; margin-bottom:15px;">Question goes here?</h2>

            <div id="options-container" class="options-grid">
                </div>

            <div id="feedback-area" class="feedback-msg"></div>
        </div>

        <div class="quiz-controls">
            <button id="btn-prev" class="nav-btn outline" onclick="navQuestion(-1)" disabled>Previous</button>
            <button id="btn-clear" class="nav-btn secondary" onclick="clearAnswer()">Eraser</button>
            <button id="btn-skip" class="nav-btn secondary" onclick="skipQuestion()">Skip</button>
            <button id="btn-next" class="nav-btn" onclick="navQuestion(1)" disabled>Next</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <header><h1>üéâ Good Effort!</h1></header>
        <div class="card" style="text-align:center;">
            <h2 id="final-score">8/10</h2>
            <p id="motivational-msg">You are learning fast!</p>
            <button onclick="retryWrong()">üîÑ Retry Mistakes</button>
            <button class="secondary" onclick="goHome()">üè† Home</button>
        </div>
        
        <h3>Review Mistakes</h3>
        <div id="review-list">
            </div>
    </div>

    <div id="flashcard-screen" class="screen">
        <header>
            <button class="outline" style="width:auto;" onclick="goHome()">Back</button>
            <h3>Flashcards</h3>
        </header>
        
        <div class="flashcard-container" onclick="flipCard()">
            <div class="flashcard-inner" id="fc-inner">
                <div class="flashcard-front">
                    <h2 id="fc-front-text">Question</h2>
                </div>
                <div class="flashcard-back">
                    <h3 id="fc-back-text">Answer</h3>
                    <small id="fc-ref" class="ref-link">Ref: Page 12</small>
                </div>
            </div>
        </div>
        
        <div class="quiz-controls">
            <button class="nav-btn outline" onclick="navFlashcard(-1)">Previous</button>
            <button class="nav-btn" onclick="navFlashcard(1)">Next</button>
        </div>
    </div>

    <div id="worksheet-view"></div>

    <script>
        // --- 1. STATE MANAGEMENT ---
        const DB_KEY = 'brightspark_db';

// --- 1.5. API Configuration (Architect Warning: Key is exposed in public JS) ---
// IMPORTANT: Replace 'YOUR_PEXELS_API_KEY_HERE' with your actual Pels Key.
const PEXELS_API_KEY = 'qQZw9X3j2A76TuOYYHDo2ssebWP5H7K056k1rpdOTVvqh7SVDQr4YyWM'; 

        let appState = {
            topics: JSON.parse(localStorage.getItem(DB_KEY)) || {},
            currentTopicId: null,
            session: {
                questions: [],     // The subset for this quiz
                currentIndex: 0,
                answers: {},       // { qId: { selectedOptionId, isCorrect, timeTaken } }
                timer: 0,
                timerInterval: null,
                isPaused: false
            }
        };

        // --- 2. AUDIO ENGINE (Base64 for offline compat) ---
        // Simple synth beeps can be used, but for MVP we assume browser defaults or add files later.
        const playSound = (type) => {
            // Placeholder: In a real app, use AudioContext or preloaded MP3s
            // console.log(`Playing sound: ${type}`);
        };

        // --- 3. CORE FUNCTIONS ---
        
        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(appState.topics));
        }

        function triggerImport() { document.getElementById('fileInput').click(); }

function handleFileUpload() {
    const file = document.getElementById('fileInput').files[0];
    const title = document.getElementById('import-title').value.trim();
    const nickname = document.getElementById('import-nickname').value.trim();

    if (!file || !title || !nickname) {
        alert("Please provide a Title, Nickname, and select a file.");
        return;
    }
    
    // Check for existing title/nickname
    const existing = Object.values(appState.topics).find(t => t.title === title || t.nickname === nickname);
    if (existing) {
        if (!confirm(`A topic with the title "${title}" or nickname "${nickname}" already exists. Do you want to DELETE the old version and replace it with this new file?`)) {
            return;
        }
        // Deletion/Replacement Logic (Requirement 1)
        delete appState.topics[existing.id];
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // Assuming JSON contains 'questions' array. If PDF, this step would be server-side OCR.
            if (!Array.isArray(data.questions)) throw new Error("File must contain a 'questions' array.");
            
            const id = Date.now().toString();
            appState.topics[id] = {
                id: id,
                title: title,       // Full User Title
                nickname: nickname, // User-chosen Nickname (GK, Maths)
                questions: data.questions,
                imageRoot: "" 
            };
            saveDB();
            closeImportModal();
            renderDashboard();
            
            // Clear inputs after successful import
            document.getElementById('import-title').value = '';
            document.getElementById('import-nickname').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileNameDisplay').innerText = 'No file selected.';

            alert(`Import Successful! Topic "${nickname}" added with ${data.questions.length} questions. üåü`);
        } catch (err) {
            alert("Error: File content is invalid or not in the expected JSON format. Please use the template.");
        }
    };
    // If PDF, we'd send the file to a server endpoint here. For PWA MVP, we read as text (JSON).
    reader.readAsText(file); 
}
// --- NEW PATH SETTING FUNCTION (Add to index.html JS) ---
function setImageRootPath(topicId, path) {
    if (appState.topics[topicId]) {
        // Ensure path ends with a slash for easy concatenation
        appState.topics[topicId].imageRoot = path.endsWith('/') ? path : path + '/';
        saveDB();
        alert(`Image path for ${appState.topics[topicId].title} set to: ${path}`);
    }
}
        function renderDashboard() {
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            
            Object.values(appState.topics).forEach(topic => {
                const li = document.createElement('li');
                li.className = 'topic-item';
                li.innerHTML = `
                <div>
                    <strong>${topic.nickname}</strong><br> 
                    <small>${topic.title} (${topic.questions.length} Qs)</small>
                </div>
                <button class="danger" style="width:auto; padding:5px 10px; font-size:0.8rem" onclick="deleteTopic('${topic.id}')">üóëÔ∏è</button>
            `;                li.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON') selectTopic(topic.id, li);
                };
                list.appendChild(li);
            });
        }

        function deleteTopic(id) {
            if(confirm("Delete this topic?")) {
                delete appState.topics[id];
                saveDB();
                renderDashboard();
                document.getElementById('action-panel').classList.add('hidden');
            }
        }

        function selectTopic(id, element) {
            document.querySelectorAll('.topic-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            appState.currentTopicId = id;
            
            const topic = appState.topics[id];
            const maxQ = topic.questions.length;
            const slider = document.getElementById('q-slider');
            slider.max = maxQ;
            slider.value = Math.min(10, maxQ);
            document.getElementById('q-count-val').innerText = slider.value;
            
            document.getElementById('action-panel').classList.remove('hidden');
        }

        function updateSlider(val) {
            document.getElementById('q-count-val').innerText = val;
        }

function openImportModal() {
    document.getElementById('import-modal').style.display = 'flex';
}
function closeImportModal() {
    document.getElementById('import-modal').style.display = 'none';
}
function updateFileName() {
    const input = document.getElementById('fileInput');
    document.getElementById('fileNameDisplay').innerText = input.files.length > 0 ? input.files[0].name : 'No file selected.';
}
        // --- 4. QUIZ ENGINE ---
// --- Start Quiz Function (Updated for Learning Zone Filtering) ---
function startQuiz(isRetry = false) {
    const topic = appState.topics[appState.currentTopicId];
    if (!topic) return;

    const selectedZoneValue = document.getElementById('grade-select').value;
    let pool = [];

    // 1. FILTER POOL BY LEARNING ZONE
    let availableQuestions = topic.questions;
    if (selectedZoneValue !== 'all' && !isRetry) {
        const centerGrade = parseInt(selectedZoneValue); // e.g., 7 for Explorer
        const minGrade = Math.max(1, centerGrade - 3);   // e.g., 4 (7-3)
        const maxGrade = centerGrade + 3;                // e.g., 10 (7+3)
        
        // Filter: Keep questions within the defined Learning Zone range (Center +/- 3)
        availableQuestions = availableQuestions.filter(q => 
            q.gradeLevel >= minGrade && q.gradeLevel <= maxGrade
        );
        
        if (availableQuestions.length === 0) {
            alert(`Warning: No questions found for the selected Learning Zone (Levels ${minGrade}-${maxGrade}). Please select 'Review Everything' or import more zoned questions.`);
            return; 
        }
    }
    
    // 2. DETERMINE FINAL QUESTION SET
    if (isRetry) {
        // Get wrong answers from previous session (Retry overrides Zone filter)
        const wrongIds = Object.keys(appState.session.answers).filter(k => !appState.session.answers[k].isCorrect);
        pool = topic.questions.filter(q => wrongIds.includes(q.id));
    } else {
        const count = parseInt(document.getElementById('q-slider').value);
        // Shuffle and slice the Zone-filtered set
        pool = [...availableQuestions].sort(() => 0.5 - Math.random()).slice(0, count);
    }

    // 3. VALIDATION 
    const requestedCount = parseInt(document.getElementById('q-slider').value);
    if (!isRetry && pool.length < requestedCount) {
        // PM Note: Rephrase warning to be encouraging.
        console.warn(`Only ${pool.length} questions were available in this zone.`);
    }

    if (pool.length === 0) { alert("No questions available in the pool!"); return; }

    // Initialize Session (rest of the logic remains the same)
    appState.session = {
        questions: pool,
        currentIndex: 0,
        answers: {},
        timer: 0,
        isPaused: false
    };
    
    // ... (rest of the timer logic is unchanged and goes here)
    if (appState.session.timerInterval) clearInterval(appState.session.timerInterval);
    appState.session.timerInterval = setInterval(() => {
        if(!appState.session.isPaused) {
            appState.session.timer++;
            const m = Math.floor(appState.session.timer / 60).toString().padStart(2,'0');
            const s = (appState.session.timer % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }
    }, 1000);

    showScreen('quiz-screen');
    renderQuestion();
}
        function renderQuestion() {
            const q = appState.session.questions[appState.session.currentIndex];
            const total = appState.session.questions.length;
            
            document.getElementById('q-number').innerText = `Q ${appState.session.currentIndex + 1}/${total}`;
            document.getElementById('q-text').innerText = q.text;
            
            // Image handling (Placeholder for Pexels API or local path)
const imgEl = document.getElementById('q-image');
if(q.image) {
    const topic = appState.topics[appState.currentTopicId];
    // Construct the full local path: [UserRootPath] + [Filename]
    imgEl.src = (topic.imageRoot || '') + q.image; 
    imgEl.classList.remove('hidden');
} else {
    imgEl.classList.add('hidden');
}

            // Options Shuffling (ensure correct answer isn't always same pos)
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            // Clone options to not mutate original data
            let options = [...q.options];
            options.sort(() => 0.5 - Math.random()); // Shuffle options

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.text;
                btn.onclick = () => selectAnswer(q.id, opt.id, q.answerId, btn);
                container.appendChild(btn);
            });

            // Reset UI state
            document.getElementById('feedback-area').innerText = '';
            document.getElementById('btn-next').disabled = true;
            document.getElementById('btn-prev').disabled = appState.session.currentIndex === 0;
            document.getElementById('btn-clear').disabled = false;
            
            // Restore state if answered
            if(appState.session.answers[q.id]) {
                const saved = appState.session.answers[q.id];
                // Visual restoration logic would go here
                document.getElementById('btn-clear').disabled = true;
                document.getElementById('btn-next').disabled = false;
            }
        }

function selectAnswer(qId, selectedOptId, correctOptId, btnElement) {
    const q = appState.session.questions[appState.session.currentIndex];
    
    // 1. Clear previous selections for this question's options
    document.querySelectorAll('.option-btn').forEach(b => {
        b.classList.remove('selected-pending', 'correct', 'wrong', 'locked');
        // Re-enable click events on all options
        b.style.pointerEvents = 'auto';
    });

    // 2. Apply the 'Selected-Pending' state to the chosen option
    btnElement.classList.add('selected-pending');
    
    // 3. Store the temporary answer
    appState.session.answers[qId] = {
        selected: selectedOptId,
        isCorrect: (selectedOptId === correctOptId),
        // We will finalize score/progress on 'Next' press
    };

    // 4. Enable Eraser and Next buttons
    document.getElementById('btn-next').disabled = false;
    document.getElementById('btn-clear').disabled = false;
}

// B. New Function: Finalize Answer (Called by 'Next' button)
function finalizeAnswer() {
    const q = appState.session.questions[appState.session.currentIndex];
    const answer = appState.session.answers[q.id];
    if (!answer || !answer.selected) return; // Should not happen if Next is enabled

    const buttons = document.querySelectorAll('.option-btn');
    const selectedBtn = document.querySelector('.selected-pending');

    // 1. Lock all options and provide immediate feedback (Green/Red)
    buttons.forEach(b => b.classList.add('locked'));
    
    if (answer.isCorrect) {
        selectedBtn.classList.add('correct');
        document.getElementById('feedback-area').innerText = "Correct! üéâ";
        document.getElementById('feedback-area').style.color = "var(--success)";
        playSound('success');
    } else {
        selectedBtn.classList.add('wrong');
        // Find and highlight the correct answer
        buttons.forEach(b => {
            if (b.innerText.trim() === q.options.find(o => o.id === q.answerId).text.trim()) {
                 b.classList.add('correct'); // Show the correct answer
            }
        });
        document.getElementById('feedback-area').innerText = "Oops! Keep trying!";
        document.getElementById('feedback-area').style.color = "var(--error)";
    }
    
    // 2. Disable Eraser after feedback is given
    document.getElementById('btn-clear').disabled = true;

    // 3. Update Score/Progress (Finalization Logic)
    const score = Object.values(appState.session.answers).filter(a => a.isCorrect).length;
    document.getElementById('q-score').innerText = `Score: ${score}`;
    
    const answeredCount = Object.keys(appState.session.answers).length;
    const pct = (answeredCount / appState.session.questions.length) * 100;
    document.getElementById('quiz-progress').style.width = `${pct}%`;

    // 4. Proceed to the next question immediately after feedback
    setTimeout(() => {
        navQuestion(1);
    }, 1200); // Give 1.2s to see feedback before moving
}

// C. Update 'clearAnswer'
function clearAnswer() {
    const qId = appState.session.questions[appState.session.currentIndex].id;
    
    // 1. Remove answer from session
    delete appState.session.answers[qId];

    // 2. Remove selected styling
    document.querySelectorAll('.option-btn').forEach(b => {
        b.classList.remove('selected-pending', 'correct', 'wrong', 'locked');
        b.style.pointerEvents = 'auto'; // Ensure options are clickable again
    });

    // 3. Update buttons
    document.getElementById('feedback-area').innerText = '';
    document.getElementById('btn-next').disabled = true;
    document.getElementById('btn-clear').disabled = true;
}

// D. Update 'navQuestion' to use finalization logic
function navQuestion(dir) {
    if (dir === 1 && document.querySelector('.selected-pending')) {
        // If moving forward and an answer is pending, finalize it first
        finalizeAnswer();
        return;
    }
    
    const newIndex = appState.session.currentIndex + dir;
    if (newIndex >= appState.session.questions.length) {
        finishQuiz();
    } else {
        appState.session.currentIndex = newIndex;
        renderQuestion();
    }
}
        function clearAnswer() {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(b => {
                b.classList.remove('locked', 'correct', 'wrong');
            });
            document.getElementById('feedback-area').innerText = '';
            // Note: In strict mode, you might not allow clearing after selection. 
            // Here we allow it *before* locking? The requirements say "before locking". 
            // My implementation locks immediately on select. 
            // To support "Eraser", we would need a "Submit" step or allow unlock.
            // Modified flow: Unlock buttons.
            buttons.forEach(b => b.classList.remove('locked'));
        }
        
        function skipQuestion() {
            navQuestion(1);
        }

        function navQuestion(dir) {
            const newIndex = appState.session.currentIndex + dir;
            if (newIndex >= appState.session.questions.length) {
                finishQuiz();
            } else {
                appState.session.currentIndex = newIndex;
                renderQuestion();
            }
        }

        function finishQuiz() {
            clearInterval(appState.session.timerInterval);
            showScreen('result-screen');
            
            const total = appState.session.questions.length;
            const correct = Object.values(appState.session.answers).filter(a => a.isCorrect).length;
            
            document.getElementById('final-score').innerText = `${correct} / ${total}`;
            
            // Render Review
            const list = document.getElementById('review-list');
            list.innerHTML = '';
            
            appState.session.questions.forEach(q => {
                const ans = appState.session.answers[q.id];
                if (!ans || !ans.isCorrect) {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.style.borderLeft = '5px solid var(--secondary)';
                    div.innerHTML = `
                        <strong>${q.text}</strong><br>
                        <span style="color:var(--success)">Correct Answer: Option ${q.answerId}</span><br>
                        <small>Ref: PDF Page ${q.refPage || 'N/A'}</small>
                    `;
                    list.appendChild(div);
                }
            });
        }
        
        function retryWrong() {
            startQuiz(true);
        }

        function exitQuiz() {
            if(confirm("Exit Quiz? Progress will be lost.")) {
                finishQuiz();
            }
        }

        // --- 5. FLASHCARDS ---
        let fcIndex = 0;
        function startFlashcards() {
            const topic = appState.topics[appState.currentTopicId];
            fcIndex = 0;
            showScreen('flashcard-screen');
            renderFlashcard();
        }
        
        function renderFlashcard() {
            const topic = appState.topics[appState.currentTopicId];
            const q = topic.questions[fcIndex];
            
            document.getElementById('fc-inner').classList.remove('flipped');
            document.getElementById('fc-front-text').innerText = q.text;
            
            // Find correct answer text
            const correctOpt = q.options.find(o => o.id === q.answerId);
            document.getElementById('fc-back-text').innerText = correctOpt ? correctOpt.text : "Answer not found";
            document.getElementById('fc-ref').innerText = `Source Page: ${q.refPage || 'N/A'}`;
        }
        
        function flipCard() {
            document.getElementById('fc-inner').classList.toggle('flipped');
        }
        
        function navFlashcard(dir) {
            const topic = appState.topics[appState.currentTopicId];
            let newIndex = fcIndex + dir;
            if (newIndex < 0) newIndex = 0;
            if (newIndex >= topic.questions.length) newIndex = topic.questions.length - 1;
            fcIndex = newIndex;
            renderFlashcard();
        }

        // --- 6. WORKSHEET GEN ---
        function generateWorksheet() {
            const topic = appState.topics[appState.currentTopicId];
            const view = document.getElementById('worksheet-view');
            view.innerHTML = '';
            
            // Create Pages (20 questions per page)
            const chunkSize = 20;
            for (let i = 0; i < topic.questions.length; i += chunkSize) {
                const chunk = topic.questions.slice(i, i + chunkSize);
                const page = document.createElement('div');
                page.className = 'worksheet-page';
                
                page.innerHTML = `<h2>${topic.title} - Worksheet ${Math.floor(i/chunkSize)+1}</h2>`;
                
                chunk.forEach((q, idx) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'ws-question';
                    qDiv.innerHTML = `
                        <p><strong>${i + idx + 1}. ${q.text}</strong></p>
                        <div style="margin-left:20px;">
                           ${q.options.map(o => `‚¨ú ${o.text}`).join('&nbsp;&nbsp;&nbsp;&nbsp;')}
                        </div>
                    `;
                    page.appendChild(qDiv);
                });
                
                view.appendChild(page);
            }
            
            window.print();
        }

        // --- 7. UTILS & INIT ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goHome() {
            showScreen('dashboard');
        }

        function downloadTemplate() {
            const template = {
                "title": "Topic Name Here",
                "questions": [
                    {
                        "id": "q1",
                        "text": "What is the capital of France?",
                        "type": "mcq",
                        "image": "", 
                        "refPage": 10,
                        "options": [
                            {"id": "A", "text": "Berlin"},
                            {"id": "B", "text": "Madrid"},
                            {"id": "C", "text": "Paris"},
                            {"id": "D", "text": "Rome"}
                        ],
                        "answerId": "C"
                    }
                ]
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(template, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "quiz_template.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Init
        renderDashboard();

    </script>
<script>
    // --- PWA REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((reg) => {
                    console.log('Service Worker Registered! Scope:', reg.scope);
                    
                    // Optional: Check for updates
                    reg.onupdatefound = () => {
                        const installingWorker = reg.installing;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('New content is available; please refresh.');
                                    // You could show a "Update Available" toast notification here
                                } else {
                                    console.log('Content is cached for offline use.');
                                }
                            }
                        };
                    };
                })
                .catch((err) => {
                    console.error('Service Worker registration failed:', err);
                });
        });
    }
</script>
<div id="import-modal" class="screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: rgba(0, 0, 0, 0.4); display: none; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px; padding: 30px; transform: scale(0.95);">
        <header>
            <h2 style="color: var(--primary);">üìù Import New Topic</h2>
            <button class="outline danger" style="width:auto; padding:5px 10px; font-size:0.8rem; box-shadow:none;" onclick="closeImportModal()">‚úï</button>
        </header>

        <label for="import-title" style="display: block; margin-bottom: 5px; font-weight: bold;">1. Topic Title (e.g., General Knowledge):</label>
        <input type="text" id="import-title" placeholder="Enter file title/topic name" 
               style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc;">
        
        <label for="import-nickname" style="display: block; margin-bottom: 5px; font-weight: bold;">2. Topic Nickname (e.g., GK):</label>
        <input type="text" id="import-nickname" placeholder="Short name for selection (GK, Maths)" 
               style="width: 100%; padding: 10px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ccc;">
        
        <label for="fileInput" style="display: block; margin-bottom: 5px; font-weight: bold;">3. Select PDF/JSON File:</label>
        <input type="file" id="fileInput" accept=".json, .pdf" style="margin-bottom: 20px;" onchange="updateFileName()">
        
        <div id="fileNameDisplay" style="margin-bottom: 15px; font-size: 0.9rem; color: #666;">No file selected.</div>

        <button onclick="handleFileUpload()">‚úÖ Confirm & Import</button>
    </div>
</div>
</body>
</html>