<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrightSpark Learning PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4D908E">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- DESIGN SYSTEM: GLASS MORPHISM & PLAYFUL --- */
        :root {
            --primary: #4D908E;     /* Teal */
            --secondary: #F94144;   /* Soft Red (Error) */
            --accent: #F9C74F;      /* Yellow (Highlight) */
            --bg-start: #E6F3FF;    /* Light Sky Blue */
            --bg-end: #F8F9FA;      /* Off-White */
            --surface: rgba(255, 255, 255, 0.9); 
            --text: #277DA1;        
            --success: #6CB85C;     
            --error: #F94144;
            --radius: 20px;         
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15); 
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            font-family: 'Comic Neue', 'Verdana', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            margin: 0; padding: 0; color: var(--text);
            min-height: 100vh;
        }

        /* --- LAYOUTS --- */
        .screen { display: none; padding: 20px; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .screen.active { display: flex; flex-direction: column; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1, h2 { margin: 0; color: var(--primary); font-weight: 800; }

        /* --- GLASS CARDS --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            margin-bottom: 20px;
        }

        /* --- BUTTONS --- */
        button {
            background: var(--primary); color: white; border: none;
            padding: 14px 24px; border-radius: 50px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            width: 100%; margin-top: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        button:active { transform: translateY(2px); box-shadow: none; }
        button.secondary { background: var(--accent); color: #333; }
        button.danger { background: var(--secondary); }
        button.outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- LISTS --- */
        .topic-item { 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.6); margin-bottom: 12px; padding: 15px;
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.4); cursor: pointer;
        }
        .topic-item.selected { border: 3px solid var(--primary); background: rgba(77, 144, 142, 0.1); }

        /* --- QUIZ UI --- */
        .option-btn { 
            text-align: left; background: white; color: var(--text);
            border: 2px solid #ddd; padding: 15px; border-radius: 16px; margin-bottom: 10px;
            width: 100%; transition: all 0.2s;
        }
        .option-btn.selected-pending { border-color: var(--primary); background: #e0f2f1; }
        .option-btn.correct { background: var(--success); color: white; border-color: #388e3c; }
        .option-btn.wrong { background: var(--error); color: white; border-color: #d32f2f; }
        .option-btn.locked { pointer-events: none; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; align-items: center; justify-content: center;
        }
        
        /* --- PRINT STYLES (Worksheets) --- */
        @media print {
            body { background: white; color: black; }
            .screen, header, button, .modal-overlay { display: none !important; }
            #worksheet-screen { display: block !important; padding: 0; }
            .worksheet-item { page-break-inside: avoid; border-bottom: 1px dashed #ccc; padding: 20px 0; }
        }
    </style>
</head>
<body>

    <div id="dashboard" class="screen active">
        <header>
            <h1>üìö My Library</h1>
            <div style="display: flex; gap: 8px;">
                <button class="outline" style="width: auto; padding: 8px 12px;" onclick="openSettings()">‚öôÔ∏è AI Key</button>
                <button class="secondary" style="width: auto; padding: 8px 16px;" onclick="openImportModal()">+ Import</button>
            </div>
        </header>

        <div id="topic-list" style="margin-bottom: 20px;">
            <div style="text-align:center; color:#888; padding: 20px;">No topics yet. Click Import!</div>
        </div>

        <div id="action-panel" class="card hidden" style="display: none;">
            <h3 id="selected-topic-title" style="margin-bottom: 15px;">Topic Actions</h3>
            
            <label style="font-weight:bold;">Learning Zone:</label>
            <select id="zone-select" style="width: 100%; padding: 10px; margin: 5px 0 15px 0; border-radius: 8px;">
                <option value="all">üöÄ Review Everything</option>
                <option value="4">üë∂ Starter (Levels 1-4)</option>
                <option value="7" selected>üí° Explorer (Levels 5-9)</option>
                <option value="10">üèÜ Master (Levels 10+)</option>
            </select>

            <label style="font-weight:bold;">Questions:</label>
            <input type="range" id="q-slider" min="5" max="50" value="10" oninput="document.getElementById('q-val').innerText = this.value">
            <div style="text-align: right; font-weight: bold; color: var(--primary); margin-bottom: 15px;"><span id="q-val">10</span> Qs</div>

            <button onclick="startQuiz()">üöÄ Start Quiz</button>
            <button class="secondary" onclick="startFlashcards()">üé¥ Flashcards</button>
            <button class="outline" onclick="generateWorksheet()">üñ®Ô∏è Print Worksheet</button>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
        <header>
            <button class="outline" style="width:auto; padding: 5px 10px;" onclick="quitQuiz()">‚úï Exit</button>
            <div id="timer" class="timer">00:00</div>
        </header>
        
        <div class="progress-container" style="background:#ddd; height:10px; border-radius:5px; margin-bottom:15px;">
            <div id="quiz-progress" style="background:var(--success); height:100%; width:0%; transition:width 0.5s;"></div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#888;">
                <span id="q-number">Q 1</span>
                <span id="q-score">Score: 0</span>
            </div>
            <h2 id="q-text" style="margin-bottom: 20px;">Question Text?</h2>
            <div id="options-container"></div>
        </div>

        <div style="min-height: 24px; text-align: center; font-weight: bold; margin-bottom: 10px;" id="feedback-area"></div>

        <div style="display: flex; gap: 10px;">
            <button id="btn-clear" class="outline" onclick="clearSelection()" disabled>Eraser</button>
            <button id="btn-next" onclick="nextQuestion()">Next ‚û°</button>
        </div>
    </div>

    <div id="flashcard-screen" class="screen">
        <header>
            <button class="outline" style="width:auto;" onclick="showScreen('dashboard')">‚¨Ö Back</button>
            <h2>Flashcards</h2>
        </header>
        <div class="card" onclick="this.classList.toggle('flipped')" style="min-height: 300px; display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; perspective: 1000px;">
            <div id="fc-content">
                <h3>Tap to Flip</h3>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between;">
            <button class="secondary" style="width:45%" onclick="prevCard()">‚¨Ö Prev</button>
            <button class="secondary" style="width:45%" onclick="nextCard()">Next ‚û°</button>
        </div>
    </div>

    <div id="worksheet-screen" style="display:none; padding: 40px;">
        <h1 id="ws-title" style="text-align:center; border-bottom: 2px solid black; padding-bottom:10px;">Practice Worksheet</h1>
        <div id="ws-content"></div>
    </div>

    <div id="import-modal" class="modal-overlay">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h2>üì• Import Content</h2>
            <p>Upload a PDF to auto-generate a quiz using AI, or a JSON file.</p>
            
            <input type="text" id="imp-title" placeholder="Full Title (e.g. Solar System)" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="text" id="imp-nick" placeholder="Nickname (e.g. Space)" style="width:100%; padding:10px; margin-bottom:10px;">
            <input type="file" id="imp-file" accept=".pdf, .json" style="margin-bottom:15px;">
            
            <button onclick="processImport()">‚úÖ Start Import</button>
            <button class="outline danger" onclick="document.getElementById('import-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="card" style="width: 90%; max-width: 400px;">
            <h2>‚öôÔ∏è AI Settings</h2>
            <p>Paste your <a href="https://aistudio.google.com/app/apikey" target="_blank">Google Gemini API Key</a> to enable PDF-to-Quiz generation.</p>
            <input type="password" id="api-key" placeholder="AIzaSy..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:8px;">
            <button onclick="saveSettings()">üíæ Save Key</button>
            <button class="outline" onclick="document.getElementById('settings-modal').style.display='none'">Close</button>
        </div>
    </div>

    <script>
        // --- 1. STATE & INIT ---
        const DB_KEY = 'brightspark_db';
        let appState = { topics: {}, currentTopicId: null, session: {} };
        
        // Load Data on Startup
        window.addEventListener('load', () => {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) appState = JSON.parse(saved);
            renderDashboard();
            
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered'));
            }
        });

        function saveDB() {
            localStorage.setItem(DB_KEY, JSON.stringify(appState));
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 2. IMPORT LOGIC (PDF + AI) ---
        function openImportModal() { document.getElementById('import-modal').style.display = 'flex'; }
        function openSettings() { document.getElementById('settings-modal').style.display = 'flex'; }

        function saveSettings() {
            const key = document.getElementById('api-key').value.trim();
            if(key) {
                localStorage.setItem('gemini_key', key);
                alert('Key Saved!');
                document.getElementById('settings-modal').style.display='none';
            }
        }

        async function processImport() {
            const file = document.getElementById('imp-file').files[0];
            const title = document.getElementById('imp-title').value;
            const nick = document.getElementById('imp-nick').value;
            const btn = document.querySelector('#import-modal button');

            if (!file || !title || !nick) return alert("Please fill all fields");

            btn.innerText = "‚è≥ Processing (Please Wait)...";
            btn.disabled = true;

            try {
                let questions = [];
                if (file.type === 'application/json') {
                    const text = await file.text();
                    questions = JSON.parse(text).questions;
                } else if (file.type === 'application/pdf') {
                    const apiKey = localStorage.getItem('gemini_key');
                    if (!apiKey) throw new Error("Please set API Key in Settings first.");
                    
                    const pdfText = await extractPdfText(file);
                    questions = await generateQuizAI(pdfText, apiKey);
                }

                const id = Date.now().toString();
                appState.topics[id] = { id, title, nickname: nick, questions };
                saveDB();
                renderDashboard();
                document.getElementById('import-modal').style.display = 'none';
                alert(`Success! Imported ${questions.length} questions.`);
            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            } finally {
                btn.innerText = "‚úÖ Start Import";
                btn.disabled = false;
            }
        }

        // PDF Helper
        async function extractPdfText(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(ab).promise;
            let text = "";
            for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ');
            }
            return text;
        }

        // AI Helper
        async function generateQuizAI(text, key) {
            const prompt = `Generate 15 quiz questions (MCQ) from this text for a Grade 6 student. Return ONLY raw JSON. Format: { "questions": [ { "id": "1", "text": "...", "options": [{"id":"a","text":"..."}], "answerId": "a" } ] } Text: ${text.substring(0, 10000)}`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            let jsonStr = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
            return JSON.parse(jsonStr).questions;
        }

        // --- 3. DASHBOARD LOGIC ---
        function renderDashboard() {
            const list = document.getElementById('topic-list');
            list.innerHTML = '';
            Object.values(appState.topics).forEach(t => {
                const div = document.createElement('div');
                div.className = 'topic-item';
                div.innerHTML = `<div><strong>${t.nickname}</strong><br><small>${t.title}</small></div>`;
                div.onclick = () => selectTopic(t.id, div);
                list.appendChild(div);
            });
        }

        function selectTopic(id, el) {
            document.querySelectorAll('.topic-item').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            appState.currentTopicId = id;
            document.getElementById('action-panel').style.display = 'block';
            document.getElementById('selected-topic-title').innerText = appState.topics[id].title;
        }

        // --- 4. QUIZ LOGIC (With Fixes) ---
        function startQuiz() {
            const topic = appState.topics[appState.currentTopicId];
            const zone = document.getElementById('zone-select').value;
            // Basic filtering logic (simulated for generated content)
            const pool = topic.questions.slice(0, parseInt(document.getElementById('q-slider').value));
            
            appState.session = {
                questions: pool,
                index: 0,
                answers: {},
                score: 0
            };
            showScreen('quiz-screen');
            renderQuestion();
        }

        function renderQuestion() {
            const q = appState.session.questions[appState.session.index];
            document.getElementById('q-number').innerText = `Q ${appState.session.index + 1}/${appState.session.questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            document.getElementById('feedback-area').innerText = '';
            document.getElementById('btn-next').innerText = (appState.session.index === appState.session.questions.length - 1) ? "Finish" : "Next ‚û°";
            
            // Reset Buttons
            document.getElementById('btn-clear').disabled = true;
            document.getElementById('btn-next').disabled = true; // Wait for selection

            const con = document.getElementById('options-container');
            con.innerHTML = '';
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt.text;
                btn.onclick = () => selectAnswer(btn, opt.id, q.answerId);
                con.appendChild(btn);
            });
        }

        function selectAnswer(btn, optId, correctId) {
            // Remove previous pending
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected-pending'));
            btn.classList.add('selected-pending');
            
            // Store temp answer
            appState.session.tempAnswer = { optId, correctId, btn };
            
            // Enable controls
            document.getElementById('btn-clear').disabled = false;
            document.getElementById('btn-next').disabled = false;
        }

        function clearSelection() {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected-pending'));
            appState.session.tempAnswer = null;
            document.getElementById('btn-clear').disabled = true;
            document.getElementById('btn-next').disabled = true;
        }

        function nextQuestion() {
            const ans = appState.session.tempAnswer;
            
            // 1. Lock and Grade
            document.querySelectorAll('.option-btn').forEach(b => b.classList.add('locked'));
            
            if (ans.optId === ans.correctId) {
                ans.btn.classList.add('correct');
                document.getElementById('feedback-area').innerText = "Correct! üéâ";
                document.getElementById('feedback-area').style.color = "var(--success)";
                appState.session.score++;
            } else {
                ans.btn.classList.add('wrong');
                document.getElementById('feedback-area').innerText = "Oops!";
                document.getElementById('feedback-area').style.color = "var(--error)";
            }
            document.getElementById('q-score').innerText = `Score: ${appState.session.score}`;

            // 2. Delay then Move
            setTimeout(() => {
                if (appState.session.index < appState.session.questions.length - 1) {
                    appState.session.index++;
                    renderQuestion();
                } else {
                    alert(`Quiz Complete! Score: ${appState.session.score}`);
                    showScreen('dashboard');
                }
            }, 1500);
        }
        
        function quitQuiz() {
            if(confirm('Exit quiz? Progress will be lost.')) showScreen('dashboard');
        }

        // --- 5. FLASHCARDS & WORKSHEET ---
        function startFlashcards() {
            appState.fcIndex = 0;
            showScreen('flashcard-screen');
            renderFlashcard();
        }

        function renderFlashcard() {
            const q = appState.topics[appState.currentTopicId].questions[appState.fcIndex];
            const correctText = q.options.find(o => o.id === q.answerId).text;
            document.getElementById('fc-content').innerHTML = `<h3>${q.text}</h3><p style="margin-top:20px; color:#666; font-size:0.9rem;">(Tap to see answer)</p><div style="display:none; margin-top:20px; color:var(--primary); font-weight:bold;">${correctText}</div>`;
            document.querySelector('.card').onclick = function() {
                this.querySelector('div[style*="none"]').style.display = 'block';
            }
        }
        function nextCard() { 
            if (appState.fcIndex < appState.topics[appState.currentTopicId].questions.length - 1) {
                appState.fcIndex++; renderFlashcard(); 
            }
        }
        function prevCard() { 
            if (appState.fcIndex > 0) { appState.fcIndex--; renderFlashcard(); }
        }

        function generateWorksheet() {
            const t = appState.topics[appState.currentTopicId];
            const con = document.getElementById('ws-content');
            con.innerHTML = '';
            document.getElementById('ws-title').innerText = t.title + " Worksheet";
            
            t.questions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'worksheet-item';
                div.innerHTML = `<strong>${i+1}. ${q.text}</strong><br>` + 
                    q.options.map(o => `<span style="display:inline-block; margin: 10px 20px 0 0;">‚¨ú ${o.text}</span>`).join('');
                con.appendChild(div);
            });
            window.print();
        }
    </script>
</body>
</html>